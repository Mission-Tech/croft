name: Infrastructure Deployment

on:
  push:
    branches:
      - '**'
      - '!dependabot/**'  # Exclude Dependabot branches
    paths:
      - 'tf/**'
      - '.github/workflows/infra.yml'
  pull_request_target:
    types: [labeled]
    # Only runs when you add the "deploy-preview" label to a PR
  release:
    types: [published]
  workflow_dispatch:

env:
  TF_VERSION: "1.9.1"
  APP: croft
  ORG: missiontech
  AWS_REGION: us-east-1

jobs:
  upload-terraform:
    # Run on push (except Dependabot), release, workflow_dispatch, or when "deploy-preview" label is added
    if: |
      (github.event_name == 'push' && github.actor != 'dependabot[bot]') ||
      github.event_name == 'release' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request_target' && github.event.label.name == 'deploy-preview')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Debug GitHub context
        run: |
          echo "GitHub Actor: ${{ github.actor }}"
          echo "GitHub Repository: ${{ github.repository }}"
          echo "GitHub Ref: ${{ github.ref }}"
          echo "GitHub SHA: ${{ github.sha }}"
          echo "GitHub Event Name: ${{ github.event_name }}"
          echo "GitHub Run ID: ${{ github.run_id }}"
          echo "GitHub Run Number: ${{ github.run_number }}"

      - name: Checkout code
        uses: actions/checkout@v5
        with:
          # For pull_request_target, checkout the PR branch, not the base branch
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.ref }}

      - name: Configure Git for private repos
        run: |
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.TOOLS_AWS_ACCOUNT_ID }}" ]; then
            echo "âŒ ERROR: TOOLS_AWS_ACCOUNT_ID is not configured as a repository secret"
            echo "Please configure TOOLS_AWS_ACCOUNT_ID in GitHub Settings > Secrets > Actions"
            exit 1
          fi
          echo "âœ… Required secrets are configured"

      - name: Configure AWS credentials for Tools account
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.TOOLS_AWS_ACCOUNT_ID }}:role/${{ env.ORG }}-${{ env.APP }}-tools-github-ci # from hoist github_ci module
          role-session-name: ${{ env.APP }}-infra
          aws-region: ${{ env.AWS_REGION }}

      - name: Prepare metadata
        id: metadata
        run: |
          echo "timestamp=$(date -u +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch_name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
          echo "author_email=$(git log -1 --pretty=format:'%ae')" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=format:'%s' | head -c 100)" >> $GITHUB_OUTPUT
          
          # Determine S3 prefix based on branch
          if [ "${GITHUB_REF}" == "refs/heads/main" ]; then
            echo "s3_prefix=main" >> $GITHUB_OUTPUT
          else
            echo "s3_prefix=branch" >> $GITHUB_OUTPUT
          fi
          
          # Extract PR number if available
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=" >> $GITHUB_OUTPUT
          fi

      - name: Create terraform bundle
        run: |
          # Create a temporary directory for the bundle
          mkdir -p /tmp/terraform-bundle
          
          # Copy all terraform files and modules
          cp -r tf /tmp/terraform-bundle/
          
          # Create metadata file with all the context
          cat > /tmp/terraform-bundle/metadata.json <<EOF
          {
            "timestamp": "${{ steps.metadata.outputs.timestamp }}",
            "commit_sha": "${{ github.sha }}",
            "short_sha": "${{ steps.metadata.outputs.short_sha }}",
            "branch": "${{ steps.metadata.outputs.branch_name }}",
            "author": "${{ steps.metadata.outputs.author }}",
            "author_email": "${{ steps.metadata.outputs.author_email }}",
            "commit_message": "${{ steps.metadata.outputs.commit_message }}",
            "pr_number": "${{ steps.metadata.outputs.pr_number }}",
            "github_run_id": "${{ github.run_id }}",
            "github_run_number": "${{ github.run_number }}",
            "github_run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "github_actor": "${{ github.actor }}",
            "github_event_name": "${{ github.event_name }}",
            "github_repository": "${{ github.repository }}",
            "terraform_version": "${{ env.TF_VERSION }}"
          }
          EOF
          
          # Include environment-specific variable information
          cat > /tmp/terraform-bundle/required_vars.json <<EOF
          {
            "dev": {
              "tools_account_id": "required"
            },
            "prod": {
              "tools_account_id": "required"
            },
            "tools": {
              "dev_account_id": "required",
              "prod_account_id": "required",
              "slack_cd_webhook_url": "required"
            }
          }
          EOF
          
          # Create the zip file
          cd /tmp/terraform-bundle
          zip -r terraform-${{ steps.metadata.outputs.timestamp }}-${{ steps.metadata.outputs.short_sha }}.zip .

      - name: Upload to S3
        run: |
          # Always use latest.zip as the key for race-free versioned uploads
          S3_KEY="${{ steps.metadata.outputs.s3_prefix }}/latest.zip"
          
          # Create a local copy with the fixed name
          BUNDLE_NAME="terraform-${{ steps.metadata.outputs.timestamp }}-${{ steps.metadata.outputs.short_sha }}.zip"
          cp "/tmp/terraform-bundle/${BUNDLE_NAME}" "/tmp/terraform-bundle/latest.zip"
          
          # Upload with metadata to the CI upload bucket
          aws s3 cp "/tmp/terraform-bundle/latest.zip" \
            "s3://${{ env.ORG }}-${{ env.APP }}-tools-${{ secrets.TOOLS_AWS_ACCOUNT_ID }}-ci-upload/${S3_KEY}" \
            --metadata "timestamp=${{ steps.metadata.outputs.timestamp }},commit-sha=${{ github.sha }},short-sha=${{ steps.metadata.outputs.short_sha }},branch=${{ steps.metadata.outputs.branch_name }},author=${{ steps.metadata.outputs.author }},pr-number=${{ steps.metadata.outputs.pr_number }},github-run-id=${{ github.run_id }},github-actor=${{ github.actor }}"
          
          echo "âœ… Uploaded terraform bundle to s3://${{ env.ORG }}-${{ env.APP }}-tools-${{ secrets.TOOLS_AWS_ACCOUNT_ID }}-ci-upload/${S3_KEY}"
          echo "ğŸ“¦ Original bundle name: ${BUNDLE_NAME}"
          echo "ğŸ”— GitHub run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
